# bedhedd's nix config
Welcome to this repo. If you would like to follow the development of this config, I posted updates here [bedHeddâ€™s NixOS Adventure](https://forum.level1techs.com/t/bedhedds-nixos-adventure/228975).

If you are already experienced with nix, you can run within the root of the cloned repository. 
```bash
nixos-rebuild switch --flake .
```

# structure of this repo
```bash
./nix-config
â”œâ”€â”€ dotfiles
â”‚Â Â  â”œâ”€â”€ example-multiple-ssh.nix
â”‚Â Â  â”œâ”€â”€ fish-config.nix
â”‚Â Â  â””â”€â”€ multiple-ssh.nix
â”œâ”€â”€ flake.lock
â”œâ”€â”€ flake.nix
â”œâ”€â”€ LICENSE
â”œâ”€â”€ machines
â”‚Â Â  â”œâ”€â”€ jade-tiger
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ default.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hardware-configuration.nix
â”‚Â Â  â”‚Â Â  â””â”€â”€ original-configuration.nix
â”‚Â Â  â”œâ”€â”€ master-of-cooling
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ default.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hardware-configuration.nix
â”‚Â Â  â”‚Â Â  â””â”€â”€ original-configuration.nix
â”‚Â Â  â””â”€â”€ think-nix
â”‚Â Â      â”œâ”€â”€ default.nix
â”‚Â Â      â”œâ”€â”€ hardware-configuration.nix
â”‚Â Â      â””â”€â”€ original-configuration.nix
â”œâ”€â”€ modules
â”‚Â Â  â”œâ”€â”€ default.nix
â”‚Â Â  â”œâ”€â”€ development.nix
â”‚Â Â  â”œâ”€â”€ entertainment.nix
â”‚Â Â  â”œâ”€â”€ guake.nix
â”‚Â Â  â”œâ”€â”€ home.nix
â”‚Â Â  â”œâ”€â”€ kde-home.nix
â”‚Â Â  â”œâ”€â”€ kde.nix
â”‚Â Â  â”œâ”€â”€ linux.nix
â”‚Â Â  â”œâ”€â”€ steamdeck-plasma-system.nix
â”‚Â Â  â””â”€â”€ universal.nix
â”œâ”€â”€ README.md
â”œâ”€â”€ scripts
â”‚Â Â  â”œâ”€â”€ helper.py
â”‚Â Â  â”œâ”€â”€ setup-wizard.py
â”‚Â Â  â””â”€â”€ template.py
â””â”€â”€ users
    â”œâ”€â”€ admin.nix
    â”œâ”€â”€ bedhedd.nix
    â”œâ”€â”€ dev.nix
    â””â”€â”€ generic-user.nix
```
## background / philosophy
The goal of this is to have a minimal modular `default.nix` file for each machine. As I add machines, I will copy the ` configuration.nix` and `hardware.nix` file generated by the installer found in `/etc/nixos/` to the machine specific folder.

I based this off of [michaelpj](https://github.com/michaelpj) nix repo structure
https://github.com/michaelpj/nixos-config/tree/master

I have configured this such that each unique machine will have a `default.nix` that imports the [`universal.nix`](./modules/universal.nix) and [`linux.nix`](./modules/linux.nix) files from modules, followed by the home-manager, nixos-hardware, hardware-configuration, and a user nix file (for example [`bedhedd.nix`](./users/bedhedd.nix)). 

[`universal.nix`](./modules/universal.nix) sets a default timezone of Chicago, english as the default language, home-manager enabled, and imports the [`home.nix`](./modules/home.nix) file from the [`modules`](./modules/) folder



## understanding the folders
- [`dotfiles`](./dotfiles/): contains cli specific customizations. E.g fish shell customizations, and ssh key management
- [`machines`](./machines/): contains all specific customizations for a given hardware configuration
- [`modules`](./modules/): contains all customizations for packages I use, shared across all machines
- [`users`](./modules/): contains all user file customizations, allows me to pull user configs for machines
- [`scripts`]: contains setup wizard scripts which will help create a config for a new machine


# getting started from scratch
## handy commands and resources
### updating nix
1. Run the following command `nix flake update`
2. Rebuild the os`nixos-rebuild switch --flake .$config-name`, replace `$config-name` with a nixos configuration defined in [flake.nix](flake.nix). Look for the line `nixosConfigurations.$config-name` to get your config. For example `nixosConfigurations.jade-tiger`, the `$config-name` would be `jade-tiger` and the command would be `nixos-rebuild switch --flake .#jade-tiger`

### handy links
- [NixOS Wiki](https://wiki.nixos.org/wiki/NixOS_Wiki): contains instructions, documentation, and sample configs for system and applications.
- [Nix Packages Search](https://search.nixos.org/): contains the repo to search for nix packages
- Recommended Nix Manuals:
  - [NixOS Manual](https://nixos.org/manual/nixos/stable/): contains instructions for using and configuring  Nix
  - [Home Manager Manual](https://nix-community.github.io/home-manager/): contains instructions for using and configuring home manager
  - [Plasma Manager Manual](https://nix-community.github.io/plasma-manager/): contains instructions for using and configuring kde plasma declaratively
- Nix community spaces
  - [Nix Community forum](https://discourse.nixos.org/): forum for nix users. People will post issues and solutions
  - [Nix Reddit](https://www.reddit.com/r/NixOS/): subreddit similar to community forum

## background
This guide assumes that your hardware is similar to mine and you wish to build a config similar to one of my machines. Note that you may need to modify it for your use case, this guide is for myself to remember when I need to come back and setup nix again.

### applying my config
After downloading this repo, navigate to the directory using your terminal or a preferred file explorer/text editor. If you run tree, this is the folder structure
```bash
./nix-config
â”œâ”€â”€ dotfiles
â”‚Â Â  â”œâ”€â”€ example-multiple-ssh.nix
â”‚Â Â  â”œâ”€â”€ fish-config.nix
â”‚Â Â  â””â”€â”€ multiple-ssh.nix
â”œâ”€â”€ flake.lock
â”œâ”€â”€ flake.nix
â”œâ”€â”€ LICENSE
â”œâ”€â”€ machines
â”‚Â Â  â”œâ”€â”€ jade-tiger
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ default.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hardware-configuration.nix
â”‚Â Â  â”‚Â Â  â””â”€â”€ original-configuration.nix
â”‚Â Â  â”œâ”€â”€ master-of-cooling
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ default.nix
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hardware-configuration.nix
â”‚Â Â  â”‚Â Â  â””â”€â”€ original-configuration.nix
â”‚Â Â  â””â”€â”€ think-nix
â”‚Â Â      â”œâ”€â”€ default.nix
â”‚Â Â      â”œâ”€â”€ hardware-configuration.nix
â”‚Â Â      â””â”€â”€ original-configuration.nix
â”œâ”€â”€ modules
â”‚Â Â  â”œâ”€â”€ default.nix
â”‚Â Â  â”œâ”€â”€ development.nix
â”‚Â Â  â”œâ”€â”€ entertainment.nix
â”‚Â Â  â”œâ”€â”€ guake.nix
â”‚Â Â  â”œâ”€â”€ home.nix
â”‚Â Â  â”œâ”€â”€ kde-home.nix
â”‚Â Â  â”œâ”€â”€ kde.nix
â”‚Â Â  â”œâ”€â”€ linux.nix
â”‚Â Â  â”œâ”€â”€ steamdeck-plasma-system.nix
â”‚Â Â  â””â”€â”€ universal.nix
â”œâ”€â”€ README.md
â”œâ”€â”€ scripts
â”‚Â Â  â”œâ”€â”€ helper.py
â”‚Â Â  â”œâ”€â”€ setup-wizard.py
â”‚Â Â  â””â”€â”€ template.py
â””â”€â”€ users
    â”œâ”€â”€ admin.nix
    â”œâ”€â”€ bedhedd.nix
    â”œâ”€â”€ dev.nix
    â””â”€â”€ generic-user.nix
```

## high level steps
1. Install nix on a machine
2. Clone or download the repository
3. Open the repository
4. Run the following command `nix run .#setup-wizard`, this will launch the setup wizard to pull your nixos config from `/etc/nixos` and create a config based on some questions:
  - Machine name 
  - Username
  - GPU manufacturer for drivers
  - The machine type (linux desktop/laptop/server, macos)

### install nix
If you have been linked this repo and have not yet installed NixOS, please start by installing nix. Follow the guide from the [wiki](https://wiki.nixos.org/wiki/NixOS_Installation_Guide). Make sure to enable kde, flakes, and unfree software if you are using the graphical installer

### download/clone this repo
Start by cloning this repo using git. Ensure that you have it installed and you have a internet connection 
```bash
git clone https://github.com/BedHedd/nix-config.git
```

If git is not installed in the terminal, download the repo as a zip. 
1. Navigate and click the green `< > Code` button 
2. Navigate and click the `Download ZIP` button


### manually modifying my config
#### create a user
Within the root of the repo, navigate to the `users` folder. Copy the [`generic-user.nix`](./users/generic-user.nix) file and update the `username`
```nix
let
  username     = "generic-user";
```  
If you need to add any user specific packages, feel free to update this section
```nix
  # ğŸ‘‡ Define exactly the packages this user wants
  userPackages = with pkgs; [
    # development packages feel free to uncomment or add additional packages
    # uv # python
    # vscodium # vscode
  ];
```

#### add a machine
Create a copy of the [`generic-machine`](./machines/generic-machine/) folder, feel free to rename the folder to the desired machine name

Review the respective `configuration.nix` and `hardware-configuration.nix` to the one generated by the installer in `/etc/nixos` to see if your machine will be similar. 

For `configuration.nix` these are the recommended variables to replace
  - `users.users.generic-user`: replacing `generic-user` with the desired username
  - `networking.hostName`: replacing `generic-machine` with the desired hostname

For`hardware-configuration.nix` copy the source file from `/etc/nixos`and paste it into the machine specific folder

##### importing my configurations to an existing `configuration.nix`
Follow these instructions if you just copied your `configuration.nix` from `/etc/nixos`

Start by adding the following imports to `configuration.nix`
```nix
  imports =
    [
      ../../modules/kde.nix
      ../../modules/steamdeck-plasma-system.nix
      ./hardware-configuration.nix
      home-manager.nixosModules.home-manager
      ./users.nix
    ];
```    

Afterwards set your `hostName` to the name you wish for your machine to show up as on the network. For example, if you are modifying the `machines/jade-tiger` config, replace `jade-tiger` in `networking.hostName`
```
  networking.hostName = "jade-tiger"; # Define your hostname.
```

If you didn't already add the experimental flakes feature, make sure to add the following line anywhere within `configuration.nix`
```
nix.settings.experimental-features = [ "nix-command" "flakes"];
```

The last thing to add is home manager and plasma manager, copy and paste the following snippet 
```
  home-manager.useGlobalPkgs   = true;
  home-manager.useUserPackages = true;

  home-manager.sharedModules = [
    plasma-manager.homeModules."plasma-manager"
  ];
```  
#### adding a user to the machine
With your configuration set, you will now need to modify the `users.nix` file within your machine specific folder. All `users.nix` does is import the files to the `configuration.nix` file. Make sure to add a new entry if you created your own user.

### update the flake
With your machine initialized, you'll now need to update `flake.nix` to include your machine. If you do not want to modify my entry, you can just update replace `generic-machine` with your machine name.

```nix
    nixosConfigurations.generic-machine = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";

      modules = [
        (import ./machines/generic-machine/configuration.nix)
        revModule
        localNixpkgsModule

        # â† pull in Homeâ€‘Manager as a NixOS module:
        home-manager.nixosModules.home-manager
      ];

      # expose both home-manager and plasma-manager into your
      # machineâ€™s specialArgs so that configuration.nix can see them:
      specialArgs = { inherit nixos-hardware home-manager plasma-manager; };
    };
```  
Otherwise copy the entry above and replace it with your machine name  

### building my config
With everything configured you will want to navigate to the root of the zip/repo. Run the following command if `generic-machine` is the only entry
```
sudo nixos-rebuild switch --flake .
```

otherwise, you'll want to run this command
```
sudo nixos-rebuild switch --flake .#generic-machine
```
replace `generic-machine` with the name of the machine you configured in the previous step

